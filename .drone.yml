---
kind: pipeline
type: kubernetes
name: default

steps:
- name: send-telegram-notification-start
  image: appleboy/drone-telegram
  settings:
    token:
      from_secret: telegram_api_key
    to:
      from_secret: telegram_owner
    format: markdown
    message: |
      ğŸš€ *Build started*: [${DRONE_REPO}](${DRONE_REPO_LINK}) - Build #{{build.number}} (type: `{{ build.event }}`)
      ğŸ“ *Commit*: {{ truncate commit.sha 8 }}
      ğŸ”€ *Branch*: {{ commit.branch }}
      ğŸŒ *Goto*: [Build Page]({{ build.link }})

- name: build-and-push-api
  image: plugins/docker
  settings:
    registry: harbor.tyokyo320.com
    repo: harbor.tyokyo320.com/rateflow/api
    username:
      from_secret: harbor_username
    password:
      from_secret: harbor_password
    dockerfile: Dockerfile
    tags:
      - ${DRONE_COMMIT_SHA:0:8}
      - ${DRONE_BRANCH}
      - latest
  when:
    branch:
      - master
      - develop

- name: build-and-push-worker
  image: plugins/docker
  settings:
    registry: harbor.tyokyo320.com
    repo: harbor.tyokyo320.com/rateflow/worker
    username:
      from_secret: harbor_username
    password:
      from_secret: harbor_password
    dockerfile: deploy/docker/worker.Dockerfile
    tags:
      - ${DRONE_COMMIT_SHA:0:8}
      - ${DRONE_BRANCH}
      - latest
  when:
    branch:
      - master
      - develop

- name: build-and-push-web
  image: plugins/docker
  settings:
    registry: harbor.tyokyo320.com
    repo: harbor.tyokyo320.com/rateflow/web
    username:
      from_secret: harbor_username
    password:
      from_secret: harbor_password
    dockerfile: web/Dockerfile
    context: web
    tags:
      - ${DRONE_COMMIT_SHA:0:8}
      - ${DRONE_BRANCH}
      - latest
  when:
    branch:
      - master
      - develop

- name: send-telegram-notification-end
  image: appleboy/drone-telegram
  when:
    status:
      - success
      - failure
  settings:
    token:
      from_secret: telegram_api_key
    to:
      from_secret: telegram_owner
    format: markdown
    message: |
      {{#success build.status}}
        âœ… *{{ uppercasefirst build.status }}*: [${DRONE_REPO}](${DRONE_REPO_LINK}) - Build #{{build.number}} (type: `{{ build.event }}`)
      {{else}}
        âŒ *{{ uppercasefirst build.status }}*: [${DRONE_REPO}](${DRONE_REPO_LINK}) - Build #{{build.number}} (type: `{{ build.event }}`)
      {{/success}}
      ğŸ“ *Commit*: {{ truncate commit.sha 8 }}
      ğŸ”€ *Branch*: {{ commit.branch }}
      ğŸŒ *Goto*: [Build Page]({{ build.link }})
      ğŸ•’ *Duration*: {{ since build.started }}

trigger:
  event:
  - push
